---

- name: stop services  # noqa no-changed-when
  ansible.builtin.service:
    name: "{{ item }}"
    state: stopped
  failed_when: false
  with_items:
    - apache2
    - openproject

- name: run openproject backup  # noqa no-changed-when
  ansible.builtin.command: "{{ openproject_backup_command }}"

- name: upgrade openproject  # noqa package-latest
  ansible.builtin.apt:
    name: openproject
    state: latest
    allow_change_held_packages: true
  notify: openproject reconfigure
  when:
    - openproject_upgrade_now is defined
    - openproject_upgrade_now | bool

- name: set openproject package on hold
  ansible.builtin.dpkg_selections:
    name: openproject
    selection: hold
  when:
    - openproject_hold_package is defined
    - openproject_hold_package | bool
    - openproject_upgrade_now is defined
    - openproject_upgrade_now | bool

- name: start services  # noqa no-changed-when
  ansible.builtin.service:
    name: "{{ item }}"
    state: started
  with_items:
    - openproject
    - apache2
